generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ENUMS

enum UserRole {
  USER
  RESPONDER
  ADMIN
}

enum DisasterType {
  FLOOD
  EARTHQUAKE
  FIRE
  CYCLONE
  LANDSLIDE
  TORNADO
  TSUNAMI
  HURRICANE
  WILDFIRE
  OTHER
}

enum Severity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum DisasterStatus {
  ACTIVE
  RESOLVED
  MONITORING
}

enum AlertType {
  WARNING
  EVACUATION
  ALL_CLEAR
  UPDATE
}

enum DeliveryStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
}

enum DeliveryMethod {
  PUSH
  SMS
  EMAIL
  IN_APP
}

enum ResourceType {
  SHELTER
  HOSPITAL
  RESCUE_TEAM
  FOOD
  WATER
  MEDICAL
  POLICE
  FIRE_STATION
}

enum ResourceAvailability {
  AVAILABLE
  LIMITED
  UNAVAILABLE
}

enum EmergencyType {
  MEDICAL
  FIRE
  TRAPPED
  INJURY
  NATURAL_DISASTER
  OTHER
}

enum SOSStatus {
  PENDING
  DISPATCHED
  IN_PROGRESS
  RESOLVED
  CANCELLED
}

enum DataCategory {
  PROTOCOL
  HISTORICAL
  REALTIME
  PREDICTION
  GUIDANCE
}

// MODELS

model User {
  id                     String   @id @default(uuid())
  email                  String   @unique
  phoneNumber            String?  @unique
  name                   String
  password               String
  preferredLanguage      String   @default("en")
  location               Json
  isVerified             Boolean  @default(false)
  emergencyContacts      Json
  role                   UserRole @default(USER)
  notificationPreferences Json
  deviceTokens           Json     @default("[]")
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  alerts                 Alert[]
  sosRequests            SOSRequest[]
  responderSOS           SOSRequest[] @relation("ResponderAssignments")
  chatSessions           ChatSession[]
  userSessions           UserSession[]

  @@index([email])
  @@index([phoneNumber])
}

model DisasterEvent {
  id                   String         @id @default(uuid())
  type                 DisasterType
  severity             Severity
  location             Json
  title                String
  description          String
  status               DisasterStatus
  dataSource           String
  predictedImpact      Json
  affectedPopulation   Int
  startTime            DateTime
  endTime              DateTime?
  metadata             Json
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt

  alerts               Alert[]
  disasterData         DisasterData[]

  @@index([type])
  @@index([status])
}

model Alert {
  id                 String         @id @default(uuid())
  disasterId         String?
  userId             String?
  alertType          AlertType
  message            String
  translatedMessages Json
  deliveryStatus     DeliveryStatus
  deliveryMethod     DeliveryMethod
  sentAt             DateTime?
  deliveredAt        DateTime?
  location           Json
  isRead             Boolean        @default(false)

  disaster           DisasterEvent? @relation(fields: [disasterId], references: [id], onDelete: Cascade)
  user               User?          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([disasterId])
  @@index([userId])
}

model ChatSession {
  id              String    @id @default(uuid())
  userId          String
  title           String?
  messages        Json
  context         Json
  language        String
  isActive        Boolean   @default(true)
  sessionMetadata Json
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model EmergencyResource {
  id             String                @id @default(uuid())
  type           ResourceType
  name           String
  description    String
  location       Json
  contactPhone   String
  contactEmail   String
  website        String?
  availability   ResourceAvailability
  capacity       Int?
  isVerified     Boolean               @default(false)
  operatingHours Json
  lastUpdated    DateTime              @updatedAt

  @@index([type])
  @@index([availability])
}

model SOSRequest {
  id                String    @id @default(uuid())
  userId            String
  location          Json
  emergencyType     EmergencyType
  status            SOSStatus
  description       String
  severity          Severity
  responderAssigned String?
  responderNotes    String?
  mediaUrls         Json
  createdAt         DateTime  @default(now())
  resolvedAt        DateTime?

  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  responder         User?     @relation("ResponderAssignments", fields: [responderAssigned], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([responderAssigned])
  @@index([status])
}

model DisasterData {
  id            String       @id @default(uuid())
  disasterId    String?
  content       String
  embedding     Bytes?
  source        String
  metadata      Json
  category      DataCategory
  language      String
  createdAt     DateTime     @default(now())

  disaster      DisasterEvent? @relation(fields: [disasterId], references: [id], onDelete: Cascade)

  @@index([disasterId])
  @@index([category])
}

model UserSession {
  id         String    @id @default(uuid())
  userId     String
  token      String    @unique
  ipAddress  String
  userAgent  String
  expiresAt  DateTime
  createdAt  DateTime  @default(now())

  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}
